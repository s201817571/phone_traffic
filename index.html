<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Phone Availability Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 10px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .phone {
        display: flex; flex-wrap: wrap; align-items: center;
        background: white; padding: 10px; margin-bottom: 10px;
        border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .phone-name { font-weight: bold; font-size: 16px; flex: 1 1 100%; }
    .btn-group { display: flex; gap: 8px; margin-top: 8px; }
    .light-btn {
        width: 30px; height: 30px; border-radius: 50%;
        border: none; cursor: pointer; flex-shrink: 0;
    }
    .green { background-color: green; }
    .red { background-color: red; cursor: not-allowed; }
    .countdown { font-size: 12px; text-align: center; height: 15px; margin-top: 2px; }
    .reset-btn {
        display: block; margin: 15px auto; padding: 10px 20px;
        font-size: 16px; background: red; color: white;
        border: none; border-radius: 5px; cursor: pointer;
    }
</style>
</head>
<body>

<h1>Phone Availability Control</h1>
<div id="ksa-time">Loading Saudi Arabia Time...</div>
<div id="phones-container"></div>
<button class="reset-btn" onclick="resetAll()">Reset All</button>

<script>
const phones = ["SAMSUNG GRAND", "Redmi 5", "infinix", "Hornor7c", "samsung galaxy a06"];
const BUTTON_DURATION = 24 * 60 * 60 * 1000; // 24h
const LOCK_OTHERS_DURATION = 2 * 60 * 60 * 1000; // 2h
const NEXT_BTN_DELAY = 4 * 60 * 60 * 1000; // 4h

let saudiOffset = 0;
let buttonState = {};
let globalLock = { until: 0, by: null };

async function fetchSaudiTimeOffset() {
    let res = await fetch("https://worldtimeapi.org/api/timezone/Asia/Riyadh");
    let data = await res.json();
    let utc = new Date(data.utc_datetime).getTime();
    let ksa = new Date(data.datetime).getTime();
    saudiOffset = ksa - utc;
}

function nowKSA() {
    return Date.now() + saudiOffset;
}

function formatCountdown(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h}h ${m}m ${s}s`;
}

function renderPhones() {
    const container = document.getElementById("phones-container");
    container.innerHTML = "";
    let now = nowKSA();

    phones.forEach(phone => {
        const phoneDiv = document.createElement("div");
        phoneDiv.className = "phone";

        const nameDiv = document.createElement("div");
        nameDiv.className = "phone-name";
        nameDiv.innerText = phone;
        phoneDiv.appendChild(nameDiv);

        const btnGroup = document.createElement("div");
        btnGroup.className = "btn-group";

        for (let i = 1; i <= 3; i++) {
            const wrapper = document.createElement("div");
            wrapper.style.textAlign = "center";

            const btn = document.createElement("button");
            btn.className = "light-btn";

            const key = `${phone}-btn${i}`;
            const state = buttonState[key] || { endTime: 0, clickedAt: 0 };

            let disabled = false;
            let lockUntil = 0;

            // Sequential rule
            if (i > 1) {
                let prevKey = `${phone}-btn${i - 1}`;
                let prevState = buttonState[prevKey] || { clickedAt: 0, endTime: 0 };
                if (prevState.clickedAt === 0) {
                    // Previous button has never been clicked
                    disabled = true;
                    btn.classList.add("red");
                    wrapper.appendChild(btn);
                    wrapper.appendChild(document.createElement("div"));
                    btnGroup.appendChild(wrapper);
                    continue;
                }
            }

            // Red if still in countdown
            if (now < state.endTime) {
                disabled = true;
                lockUntil = state.endTime;
                btn.classList.add("red");
            } else {
                btn.classList.add("green");
            }

            // Lock other phones for 2h if a first button clicked
            if (globalLock.until > now && globalLock.by !== phone) {
                disabled = true;
                lockUntil = Math.max(lockUntil, globalLock.until);
                btn.classList.remove("green");
                btn.classList.add("red");
            }

            // 4h wait rule inside same phone
            if (i === 2) {
                let btn1 = buttonState[`${phone}-btn1`] || { clickedAt: 0 };
                let waitUntil = btn1.clickedAt + NEXT_BTN_DELAY;
                if (btn1.clickedAt && now < waitUntil) {
                    disabled = true;
                    lockUntil = Math.max(lockUntil, waitUntil);
                    btn.classList.remove("green");
                    btn.classList.add("red");
                }
            }
            if (i === 3) {
                let btn2 = buttonState[`${phone}-btn2`] || { clickedAt: 0 };
                let waitUntil = btn2.clickedAt + NEXT_BTN_DELAY;
                if (btn2.clickedAt && now < waitUntil) {
                    disabled = true;
                    lockUntil = Math.max(lockUntil, waitUntil);
                    btn.classList.remove("green");
                    btn.classList.add("red");
                }
            }

            btn.disabled = disabled;

            btn.addEventListener("click", () => {
                if (btn.disabled) return;
                let clickTime = nowKSA();
                buttonState[key] = { endTime: clickTime + BUTTON_DURATION, clickedAt: clickTime };
                if (i === 1) {
                    globalLock = { until: clickTime + LOCK_OTHERS_DURATION, by: phone };
                }
                renderPhones();
            });

            wrapper.appendChild(btn);

            const countdown = document.createElement("div");
            countdown.className = "countdown";
            countdown.innerText = (lockUntil > now) ? formatCountdown(lockUntil - now) : "";
            wrapper.appendChild(countdown);

            btnGroup.appendChild(wrapper);
        }

        phoneDiv.appendChild(btnGroup);
        container.appendChild(phoneDiv);
    });
}

function resetAll() {
    if (confirm("Are you sure you want to reset all timers?")) {
        buttonState = {};
        globalLock = { until: 0, by: null };
        renderPhones();
    }
}

setInterval(() => {
    document.getElementById("ksa-time").innerText =
        "Saudi Arabia Time: " + new Date(nowKSA()).toLocaleTimeString("en-SA", { hour12: false });
    renderPhones();
}, 1000);

(async () => {
    await fetchSaudiTimeOffset();
    renderPhones();
})();
</script>

</body>
</html>
