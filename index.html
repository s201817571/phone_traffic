<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Availability Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .phone-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .phone-section.locked {
            background-color: #ffe6e6;
            border-color: #ff9999;
        }
        .phone-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .button-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .phone-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        .phone-button.available {
            background-color: #4CAF50;
            color: white;
        }
        .phone-button.available:hover {
            background-color: #45a049;
        }
        .phone-button.clicked {
            background-color: #2196F3;
            color: white;
        }
        .phone-button.disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        .timer-display {
            margin-top: 10px;
            font-weight: bold;
            color: #666;
        }
        .global-lock-display {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #856404;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 6px;
        }
        .control-button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .reset-button {
            background-color: #dc3545;
            color: white;
        }
        .export-button {
            background-color: #28a745;
            color: white;
        }
        .import-button {
            background-color: #007bff;
            color: white;
        }
        .file-input {
            margin: 5px;
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Phone Availability Control System</h1>
        
        <div class="controls">
            <button class="control-button reset-button" onclick="resetAll()">Reset All</button>
            <button class="control-button export-button" onclick="exportData()">Export JSON</button>
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
            <button class="control-button import-button" onclick="document.getElementById('importFile').click()">Import JSON</button>
            <div id="statusMessage"></div>
        </div>

        <div id="globalLockDisplay" class="global-lock-display" style="display: none;"></div>

        <div id="phoneContainer"></div>
    </div>

    <script>
        // Phone configuration
        const phones = [
            { id: 'phone1', name: 'Phone 1', buttons: ['Button A', 'Button B', 'Button C'] },
            { id: 'phone2', name: 'Phone 2', buttons: ['Button A', 'Button B', 'Button C'] },
            { id: 'phone3', name: 'Phone 3', buttons: ['Button A', 'Button B', 'Button C'] },
            { id: 'phone4', name: 'Phone 4', buttons: ['Button A', 'Button B', 'Button C'] },
            { id: 'phone5', name: 'Phone 5', buttons: ['Button A', 'Button B', 'Button C'] }
        ];

        // State management
        let buttonState = {};
        let globalLock = { active: false, endTime: null, lockedPhones: [] };

        // Initialize button states
        function initializeStates() {
            phones.forEach(phone => {
                buttonState[phone.id] = {
                    clickedButtons: [],
                    buttonTimers: {},
                    lastClickTime: null
                };
            });
        }

        // Saudi Arabia timezone offset calculation
        function getSaudiTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const saudiTime = new Date(utc + (3 * 3600000)); // UTC+3
            return saudiTime;
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            const data = {
                buttonState: buttonState,
                globalLock: globalLock,
                timestamp: getSaudiTime().toISOString()
            };
            try {
                localStorage.setItem('phoneTimerData', JSON.stringify(data));
                showStatus('Data saved successfully', 'success');
            } catch (error) {
                showStatus('Error saving data: ' + error.message, 'error');
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('phoneTimerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    buttonState = data.buttonState || {};
                    globalLock = data.globalLock || { active: false, endTime: null, lockedPhones: [] };
                    
                    // Ensure all phones have state
                    phones.forEach(phone => {
                        if (!buttonState[phone.id]) {
                            buttonState[phone.id] = {
                                clickedButtons: [],
                                buttonTimers: {},
                                lastClickTime: null
                            };
                        }
                    });
                    
                    showStatus(`Data loaded from ${data.timestamp || 'unknown time'}`, 'success');
                    return true;
                }
            } catch (error) {
                showStatus('Error loading data: ' + error.message, 'error');
            }
            return false;
        }

        // Export data as JSON file
        function exportData() {
            const data = {
                buttonState: buttonState,
                globalLock: globalLock,
                exportTime: getSaudiTime().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `phone-timer-data-${getSaudiTime().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
            
            showStatus('Data exported successfully', 'success');
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.buttonState && data.globalLock) {
                        buttonState = data.buttonState;
                        globalLock = data.globalLock;
                        
                        // Ensure all phones have state
                        phones.forEach(phone => {
                            if (!buttonState[phone.id]) {
                                buttonState[phone.id] = {
                                    clickedButtons: [],
                                    buttonTimers: {},
                                    lastClickTime: null
                                };
                            }
                        });
                        
                        saveToLocalStorage();
                        updateDisplay();
                        showStatus(`Data imported from ${data.exportTime || 'unknown time'}`, 'success');
                    } else {
                        showStatus('Invalid JSON file format', 'error');
                    }
                } catch (error) {
                    showStatus('Error importing data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // Format time remaining
        function formatTimeRemaining(endTime) {
            const now = getSaudiTime();
            const remaining = endTime - now;
            
            if (remaining <= 0) return null;
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Check if button is available
        function isButtonAvailable(phoneId, buttonIndex) {
            const phone = buttonState[phoneId];
            const now = getSaudiTime();
            
            // Check if phone is globally locked
            if (globalLock.active && globalLock.lockedPhones.includes(phoneId)) {
                if (now < new Date(globalLock.endTime)) {
                    return false;
                }
            }
            
            // Check if button is in cooldown or waiting to unlock
            if (phone.buttonTimers[buttonIndex]) {
                if (now < new Date(phone.buttonTimers[buttonIndex])) {
                    return false;
                }
            }
            
            // Check sequential requirement (must click buttons in order)
            if (buttonIndex > 0 && !phone.clickedButtons.includes(buttonIndex - 1)) {
                return false;
            }
            
            return true;
        }

        // Handle button click
        function handleButtonClick(phoneId, buttonIndex) {
            if (!isButtonAvailable(phoneId, buttonIndex)) return;
            
            const now = getSaudiTime();
            const phone = buttonState[phoneId];
            
            // Mark button as clicked
            if (!phone.clickedButtons.includes(buttonIndex)) {
                phone.clickedButtons.push(buttonIndex);
            }
            
            // Set 24-hour cooldown for the clicked button
            phone.buttonTimers[buttonIndex] = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            phone.lastClickTime = now.toISOString();
            
            // Set 4-hour unlock timer for the next button in sequence
            if (buttonIndex === 0) {
                // Button 1 clicked -> Button 2 unlocks after 4h
                phone.buttonTimers[1] = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            } else if (buttonIndex === 1) {
                // Button 2 clicked -> Button 3 unlocks after 4h
                phone.buttonTimers[2] = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            }
            
            // If this is the first button of any phone, activate global lock
            if (buttonIndex === 0) {
                const otherPhones = phones.filter(p => p.id !== phoneId).map(p => p.id);
                globalLock = {
                    active: true,
                    endTime: new Date(now.getTime() + 2 * 60 * 60 * 1000).toISOString(),
                    lockedPhones: otherPhones
                };
            }
            
            saveToLocalStorage();
            updateDisplay();
        }

        // Reset all data
        function resetAll() {
            if (confirm('Are you sure you want to reset all timers?')) {
                initializeStates();
                globalLock = { active: false, endTime: null, lockedPhones: [] };
                saveToLocalStorage();
                updateDisplay();
                showStatus('All timers reset', 'success');
            }
        }

        // Create phone UI
        function createPhoneUI() {
            const container = document.getElementById('phoneContainer');
            container.innerHTML = '';
            
            phones.forEach(phone => {
                const phoneDiv = document.createElement('div');
                phoneDiv.className = 'phone-section';
                phoneDiv.id = phone.id;
                
                const title = document.createElement('div');
                title.className = 'phone-title';
                title.textContent = phone.name;
                phoneDiv.appendChild(title);
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
                
                phone.buttons.forEach((buttonName, index) => {
                    const button = document.createElement('button');
                    button.className = 'phone-button';
                    button.textContent = buttonName;
                    button.onclick = () => handleButtonClick(phone.id, index);
                    button.id = `${phone.id}-button-${index}`;
                    buttonContainer.appendChild(button);
                    
                    const timerDiv = document.createElement('div');
                    timerDiv.className = 'timer-display';
                    timerDiv.id = `${phone.id}-timer-${index}`;
                    buttonContainer.appendChild(timerDiv);
                });
                
                phoneDiv.appendChild(buttonContainer);
                container.appendChild(phoneDiv);
            });
        }

        // Update display
        function updateDisplay() {
            const now = getSaudiTime();
            
            // Update global lock display
            const globalLockDiv = document.getElementById('globalLockDisplay');
            if (globalLock.active && now < new Date(globalLock.endTime)) {
                const remaining = formatTimeRemaining(new Date(globalLock.endTime));
                if (remaining) {
                    globalLockDiv.textContent = `Global Lock Active - ${remaining} remaining`;
                    globalLockDiv.style.display = 'block';
                } else {
                    globalLock.active = false;
                    globalLockDiv.style.display = 'none';
                }
            } else {
                globalLock.active = false;
                globalLockDiv.style.display = 'none';
            }
            
            // Update phone displays
            phones.forEach(phone => {
                const phoneDiv = document.getElementById(phone.id);
                const phoneState = buttonState[phone.id];
                
                // Check if phone is locked
                const isLocked = globalLock.active && globalLock.lockedPhones.includes(phone.id) && now < new Date(globalLock.endTime);
                phoneDiv.className = isLocked ? 'phone-section locked' : 'phone-section';
                
                phone.buttons.forEach((buttonName, index) => {
                    const button = document.getElementById(`${phone.id}-button-${index}`);
                    const timerDiv = document.getElementById(`${phone.id}-timer-${index}`);
                    
                    const isAvailable = isButtonAvailable(phone.id, index);
                    const isClicked = phoneState.clickedButtons.includes(index);
                    
                    if (isClicked) {
                        button.className = 'phone-button clicked';
                        button.disabled = false;
                    } else if (isAvailable) {
                        button.className = 'phone-button available';
                        button.disabled = false;
                    } else {
                        button.className = 'phone-button disabled';
                        button.disabled = true;
                    }
                    
                    // Show timer if button is in cooldown or waiting to unlock
                    if (phoneState.buttonTimers[index]) {
                        const remaining = formatTimeRemaining(new Date(phoneState.buttonTimers[index]));
                        if (remaining) {
                            // Determine if this is a cooldown (button was clicked) or unlock timer (waiting to become available)
                            const timerType = isClicked ? 'Cooldown' : 'Unlocks in';
                            timerDiv.textContent = `${timerType}: ${remaining}`;
                        } else {
                            delete phoneState.buttonTimers[index];
                            timerDiv.textContent = '';
                        }
                    } else {
                        timerDiv.textContent = '';
                    }
                });
            });
        }

        // Initialize application
        function init() {
            initializeStates();
            
            // Try to load saved data
            if (!loadFromLocalStorage()) {
                showStatus('Starting fresh - no saved data found', 'success');
            }
            
            createPhoneUI();
            updateDisplay();
            
            // Update display every second
            setInterval(updateDisplay, 1000);
        }

        // Start the application
        init();
    </script>
</body>
</html>
